#!/bin/bash

# sourcing our current rc.conf requires this to be a bash script
. @RCLIBDIR@/functions

cleaning(){
    install -m0664 -o root -g utmp /dev/null /run/utmp
    if [ ! -e /var/log/wtmp ]; then
        install -m0664 -o root -g utmp /dev/null /var/log/wtmp
    fi
    if [ ! -e /var/log/btmp ]; then
        install -m0600 -o root -g utmp /dev/null /var/log/btmp
    fi

    rm -f /etc/nologin /forcefsck /forcequotacheck /fastboot
}

case "$1" in
    start)
        stat_busy "Cleaning up"
        cleaning
        add_daemon cleanup
        stat_done
        ;;
    stop)
        halt -w # Well, this actually does nothing.
        stat_busy "Sending TERM signal to processes"
        pkill --inverse -s0,1 -TERM
        sleep 1
        stat_done
        stat_busy "Sending KILL signal to processes"
        pkill --inverse -s0,1 -KILL
        sleep 1
        rm_daemon cleanup
        stat_done
        ;;
    *)
        echo "usage: $0 {start|stop}"
        exit 1
        ;;
esac
