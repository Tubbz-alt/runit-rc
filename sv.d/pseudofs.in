#!/bin/bash

# sourcing our current rc.conf requires this to be a bash script
. @RCLIBDIR@/functions

mount_procfs(){
    mountpoint -q /proc || mount -t proc proc /proc -o nosuid,noexec,nodev
}

mount_sysfs() {
    mountpoint -q /sys || mount -t sysfs sys /sys -o nosuid,noexec,nodev
    mountpoint -q /sys/kernel/security || mount -n -t securityfs securityfs /sys/kernel/security
    if [ -d /sys/firmware/efi ]; then
        mountpoint -q /sys/firmware/efi/efivars || mount -n -t efivarfs -o ro efivarfs /sys/firmware/efi/efivars
    fi
}

mount_runfs() {
    mountpoint -q /run || mount -o mode=0755,nosuid,nodev -t tmpfs run /run
    mkdir -p /run/{runit,lvm,user,lock,log}
}

mount_devfs() {
    mountpoint -q /dev || mount -o mode=0755,nosuid -t devtmpfs dev /dev
    mkdir -p -m0755 /dev/{pts,shm}
    mountpoint -q /dev/pts || mount -o mode=0620,gid=5,nosuid,noexec -n -t devpts devpts /dev/pts
    mountpoint -q /dev/shm || mount -o mode=1777,nosuid,nodev -n -t tmpfs shm /dev/shm
}

case "$1" in
    start)
        stat_busy "Mounting proc filesystem"
        mount_procfs
        stat_done
        stat_busy "Mounting sys filesystem"
        mount_sysfs
        stat_done
        stat_busy "Mounting run filesystem"
        mount_runfs
        stat_done
        stat_busy "Mounting devfs"
        mount_devfs
        stat_done
        add_daemon pseudofs
    ;;
    *)
        echo "usage: $0 {start}"
        exit 1
    ;;
esac
